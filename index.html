<!doctype html>
<html lang="en">
<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

	<title>Json Generator</title>
</head>
<body>
	<h1 class="text-center ">Firebase Config JSON Generator</h1>

	<div class="container">
		<form id="myForm">


			<div class="form-group row">

				<label for="AB_TestName" class="col-sm-3 col-form-label">AB Test Name</label>
				<div class="col-sm-9">
					<input type="text" class="form-control" id="ABTestName" name="AB_TestName" placeholder="ExampleTest">
				</div>
			</div>


			<div class="form-group mb-2" id="parameterList">

				
			</div>


			<button class="btn btn-primary mb-3" id="generateJson">Generate json</button>
			<button  class="btn btn-primary mb-3" id="addParamButton">Add new parameter</button>


		</form>

	
		<textarea class="container" name="jsonExample" id="jsonExample" placeholder="Click the generate json button to see the json..." readonly rows="10"></textarea>
<div class="text-right">
		<button class="btn btn-primary mb-3 text-right" id="saveFile">Save json to file</button>
</div>



		<!-- template parameter -->
			<form class="form-row d-none" id="template-parameter">
				<div class="form-group mb-2">
					<label for="parameterName" >Name</label>
					<input type="text" class="form-control" id="parameterName" name="parameterName" placeholder="Parameter name">
				</div>
				<div class="form-group mx-3 mb-2">
					<label for="parameterValue">Value</label>
					<input type="text" class="form-control" id="parameterValue" name="parameterValue" placeholder="Parameter value">
				</div>
				<div class="form-group col-2">
					<label for="parameterValueType">Type</label>
					<select  name="parameterValueType" class="form-control">
						<option value="bool">Bool</option>
						<option value="int">Integer</option>
						<option value="string" selected="">String</option>
						<option value="float">Float</option>
					</select>
				</div>

					<button type="button" class="close ml-4" aria-label="Close" name="delete" >
					  <span aria-hidden="true">&times;</span>
					</button>

			</form>
		</div>

		<!-- Optional JavaScript -->
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	</body>
	<script>
		let jsonText;
		let fileName = "TestExample";

		var saveToFileModule = (function () {
			var textFile = null,
			  makeTextFile = function (text) {
			    var data = new Blob([text], {type: 'application/json'});

			    // If we are replacing a previously generated file we need to
			    // manually revoke the object URL to avoid memory leaks.
			    if (textFile !== null) {
			      window.URL.revokeObjectURL(textFile);
			    }

			    textFile = window.URL.createObjectURL(data);

			    return textFile;
			  };

			  return {
			  	makeTextFile,
			  	textFile
			  }
			})();

		// 
		$( document ).ready(function() {
			console.log( "ready!" );

			// add a new parameter field on click
			$("#addParamButton").click(function(event) {
				event.stopPropagation();
				event.preventDefault();

				console.log( "added a parameter field!" );

				var newParam = $("[id=template-parameter]").clone(true).appendTo('#parameterList').removeClass('d-none').attr('id', '');
				newParam.children('[name=delete]').click(function(event) {
					event.stopPropagation();
					event.preventDefault();

					newParam.remove();
				});
			});

			// generate the json string (formatted)
			$("#generateJson").click(function(event) {
				event.stopPropagation();
				event.preventDefault();

				jsonText="";

				console.log( "Generating json!" );

				var jsonData = {};

				// first record of json is name of test
				var formData = $("#myForm").serializeArray();
				console.log(formData);
				var testName = formData.pop();
				jsonData[testName.name] = testName.value;
				console.log(jsonData);

				// conversion function
				const reducer = (accumulator, currentvalue) => {
					return accumulator[Object.keys(currentvalue)[0]];
				}

				// now fetch individual parameters
				jsonData["parameterList"] = [];
				$('#parameterList').children('form').each(function(index, el) {
					var paramAsAnArray = $(el).serializeArray();
					// formData.push($(el).serializeArray());
					// console.log(formData);
					console.log(paramAsAnArray);

					var paramAsAnObj = paramAsAnArray.reduce(
						(obj, item) => Object.assign(obj, { [item.name]: item.value }), {});
					// console.log(paramAsAnObj);

					jsonData["parameterList"].push(paramAsAnObj);
				});
				// console.log(jsonData);
				var jsonString = JSON.stringify(jsonData, null, 2);
				// console.log(jsonString);


				// show in text area
				$(jsonExample).val(jsonString);
				
				jsonText = jsonString;
				fileName = testName.value != "" ? testName.value : "test";
				// perform validation



		  });

			// save json to file
		  $("#saveFile").click(function(event) {
		   	    var link = document.createElement('a');
		   	    link.setAttribute('download', fileName);
		   	    link.href = saveToFileModule.makeTextFile(jsonText);
		   	    document.body.appendChild(link);

		   	    // wait for the link to be added to the document
		   	    window.requestAnimationFrame(function () {
		   	      var event = new MouseEvent('click');
		   	      link.dispatchEvent(event);
		   	      document.body.removeChild(link);
		   			});
		   });

		});
	</script>
	</html>